<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© - Ù‡Ø§ÙŠ ØªÙƒ</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1E293B 0%, #0F172A 30%, #22C55E 100%);
            min-height: 100vh;
            padding: 20px;
            color: white;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 32px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #22C55E;
        }

        .demo-section {
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
        }

        .demo-button {
            background: linear-gradient(135deg, #22C55E, #16A34A);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
        }

        .demo-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(34, 197, 94, 0.4);
        }

        .demo-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .status {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            font-weight: 600;
        }

        .status.success {
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid #22C55E;
            color: #22C55E;
        }

        .status.error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid #EF4444;
            color: #EF4444;
        }

        .status.info {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid #3B82F6;
            color: #3B82F6;
        }

        .instruction {
            background: rgba(59, 130, 246, 0.1);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border-right: 4px solid #3B82F6;
        }

        .step {
            margin: 15px 0;
            padding-right: 30px;
            position: relative;
        }

        .step::before {
            content: "âœ“";
            position: absolute;
            right: 0;
            color: #22C55E;
            font-weight: bold;
        }

        .highlight {
            background: rgba(239, 68, 68, 0.2);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border-right: 4px solid #EF4444;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”” Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©</h1>
        
        <div class="highlight">
            <h3>ğŸš€ ØªØ­Ø¯ÙŠØ« Ù…Ù‡Ù…: Ø§Ù„Ø¢Ù† Ù…Ø¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©!</h3>
            <p>ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¢Ù† Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ØªØ¹Ù…Ù„ Ø­ØªÙ‰ Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØªØµÙØ­Ø§Øª Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹!</p>
        </div>
        
        <div class="instruction">
            <h3>ğŸ“± ÙƒÙŠÙÙŠØ© Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©:</h3>
            <div class="step">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©"</div>
            <div class="step">Ø§Ø³Ù…Ø­ Ø¨Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¹Ù†Ø¯ Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø°Ù†</div>
            <div class="step">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø®Ù„ÙÙŠ Ø­Ù‚ÙŠÙ‚ÙŠ"</div>
            <div class="step">Ø£ØºÙ„Ù‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØªØµÙØ­Ø§Øª Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹</div>
            <div class="step">Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ± Ø§Ù„Ø¢Ø®Ø± Ø£Ùˆ API Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± - ÙŠØ¬Ø¨ Ø£Ù† ÙŠØµÙ„ Ø­ØªÙ‰ Ù…Ø¹ Ø¥ØºÙ„Ø§Ù‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØªØµÙØ­Ø§Øª!</div>
        </div>
        
        <div class="demo-section">
            <h3>ğŸ”§ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©</h3>
            <button class="demo-button" id="enablePush">
                ğŸ“± ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©
            </button>
            <div id="pushStatus"></div>
        </div>
        
        <div class="demo-section">
            <h3>ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h3>
            <button class="demo-button" id="testBackground">
                ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø®Ù„ÙÙŠ Ø­Ù‚ÙŠÙ‚ÙŠ
            </button>
            <button class="demo-button" id="testUrgent">
                ğŸš¨ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¹Ø§Ø¬Ù„ Ø®Ù„ÙÙŠ
            </button>
        </div>
        
        <div class="demo-section">
            <h3>ğŸ“Š Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h3>
            <div id="systemInfo"></div>
        </div>
        
        <div class="demo-section">
            <h3>ğŸ”— Ø§Ø®ØªØ¨Ø§Ø± Ù…Ù† Ø®Ø§Ø±Ø¬ Ø§Ù„ØµÙØ­Ø©</h3>
            <p>Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©ØŒ Ø§Ø³ØªØ®Ø¯Ù…:</p>
            <pre style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; overflow-x: auto;">
curl -X POST http://10.10.10.196:3000/api/push/send \\
  -H "Content-Type: application/json" \\
  -d '{
    "token": "hitech_admin_2025",
    "notificationType": "maintenance_alert",
    "title": "Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø®Ù„ÙÙŠ",
    "message": "Ù‡Ø°Ø§ ÙŠØ¹Ù…Ù„ Ø­ØªÙ‰ Ù…Ø¹ Ø¥ØºÙ„Ø§Ù‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØªØµÙØ­Ø§Øª! ğŸš€",
    "priority": "urgent"
  }'
            </pre>
        </div>
    </div>

    <script>
        let pushSupported = false;
        let pushSubscription = null;

        // Helper function to convert VAPID key
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        // Check system capabilities
        function updateSystemInfo() {
            const info = {
                'Service Worker': 'serviceWorker' in navigator ? 'âœ… Ù…Ø¯Ø¹ÙˆÙ…' : 'âŒ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…',
                'Push API': 'PushManager' in window ? 'âœ… Ù…Ø¯Ø¹ÙˆÙ…' : 'âŒ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…',  
                'Notifications': 'Notification' in window ? 'âœ… Ù…Ø¯Ø¹ÙˆÙ…' : 'âŒ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…',
                'Permission': Notification.permission === 'granted' ? 'âœ… Ù…Ù…Ù†ÙˆØ­' : 
                             Notification.permission === 'denied' ? 'âŒ Ù…Ø±ÙÙˆØ¶' : 'â³ Ù„Ù… ÙŠÙØ·Ù„Ø¨ Ø¨Ø¹Ø¯',
                'VAPID Support': 'PushManager' in window && 'getKey' in PushSubscription.prototype ? 'âœ… Ù…Ø¯Ø¹ÙˆÙ…' : 'âŒ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…'
            };
            
            document.getElementById('systemInfo').innerHTML = 
                Object.entries(info).map(([key, value]) => `<div><strong>${key}:</strong> ${value}</div>`).join('');
        }

        // Enable real push notifications
        async function enablePushNotifications() {
            const enableBtn = document.getElementById('enablePush');
            const statusDiv = document.getElementById('pushStatus');
            
            enableBtn.disabled = true;
            enableBtn.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ...';
            
            try {
                // Request notification permission
                if (Notification.permission === 'default') {
                    const permission = await Notification.requestPermission();
                    if (permission !== 'granted') {
                        throw new Error('ØªÙ… Ø±ÙØ¶ Ø¥Ø°Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª');
                    }
                }
                
                // Get VAPID public key from server
                const vapidResponse = await fetch('/api/push/vapid-public-key');
                if (!vapidResponse.ok) {
                    throw new Error('ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙØªØ§Ø­ VAPID');
                }
                const vapidData = await vapidResponse.json();
                const vapidPublicKey = vapidData.publicKey;
                
                console.log('ğŸ”‘ VAPID Public Key received:', vapidPublicKey);
                statusDiv.innerHTML = '<div class="status info">ğŸ”‘ ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙØªØ§Ø­ VAPID...</div>';
                
                // Register service worker
                if ('serviceWorker' in navigator) {
                    const registration = await navigator.serviceWorker.register('/sw.js');
                    console.log('Service Worker registered:', registration);
                    statusDiv.innerHTML = '<div class="status info">ğŸ‘· ØªÙ… ØªØ³Ø¬ÙŠÙ„ Service Worker...</div>';
                    
                    // Subscribe to push notifications with VAPID key
                    if ('PushManager' in window) {
                        pushSubscription = await registration.pushManager.subscribe({
                            userVisibleOnly: true,
                            applicationServerKey: urlBase64ToUint8Array(vapidPublicKey)
                        });
                        
                        console.log('Real Push subscription:', pushSubscription);
                        statusDiv.innerHTML = '<div class="status info">ğŸ“¡ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ...</div>';
                        
                        // Send subscription to server
                        const response = await fetch('/api/push/subscribe', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                subscription: pushSubscription.toJSON(),
                                clientId: 'real_demo_' + Date.now()
                            })
                        });
                        
                        if (!response.ok) {
                            throw new Error('ÙØ´Ù„ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…');
                        }
                        
                        const result = await response.json();
                        console.log('Real subscription registered:', result);
                        
                        pushSupported = true;
                        statusDiv.innerHTML = '<div class="status success">âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!</div>';
                        enableBtn.textContent = 'âœ… Ù…ÙÙØ¹Ù„ (Ø­Ù‚ÙŠÙ‚ÙŠ)';
                        
                        // Show test notification immediately
                        setTimeout(() => {
                            statusDiv.innerHTML += '<div class="status success">ğŸ”” Ø¬Ø±Ø¨ Ø¥ØºÙ„Ø§Ù‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØªØµÙØ­Ø§Øª Ø«Ù… Ø£Ø±Ø³Ù„ Ø¥Ø´Ø¹Ø§Ø±!</div>';
                        }, 1000);
                        
                    } else {
                        throw new Error('Push Manager ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…');
                    }
                } else {
                    throw new Error('Service Workers ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…');
                }
                
            } catch (error) {
                console.error('Error enabling real push notifications:', error);
                statusDiv.innerHTML = `<div class="status error">âŒ Ø®Ø·Ø£: ${error.message}</div>`;
                enableBtn.disabled = false;
                enableBtn.textContent = 'ğŸ“± ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©';
            }
            
            updateSystemInfo();
        }

        // Send test notifications
        async function sendTestNotification(type) {
            const notifications = {
                background: {
                    notificationType: 'maintenance_alert',
                    title: 'Ø¥Ø´Ø¹Ø§Ø± Ø®Ù„ÙÙŠ Ø­Ù‚ÙŠÙ‚ÙŠ',
                    message: 'Ù‡Ø°Ø§ Ø¥Ø´Ø¹Ø§Ø± Ø®Ù„ÙÙŠ Ø­Ù‚ÙŠÙ‚ÙŠ ÙŠØ¹Ù…Ù„ Ø­ØªÙ‰ Ù…Ø¹ Ø¥ØºÙ„Ø§Ù‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØªØµÙØ­Ø§Øª! ğŸš€',
                    priority: 'high'
                },
                urgent: {
                    notificationType: 'connection_lost',
                    title: 'Ø¥Ø´Ø¹Ø§Ø± Ø¹Ø§Ø¬Ù„ Ø®Ù„ÙÙŠ',
                    message: 'âš ï¸ Ù‡Ø°Ø§ Ø¥Ø´Ø¹Ø§Ø± Ø¹Ø§Ø¬Ù„ Ø­Ù‚ÙŠÙ‚ÙŠ - Ø£ØºÙ„Ù‚ Ø§Ù„Ù…ØªØµÙØ­ ÙˆØ§Ø®ØªØ¨Ø±Ù‡!',
                    priority: 'urgent'
                }
            };
            
            const notificationData = notifications[type];
            
            try {
                // Send real background push notification
                const response = await fetch('/api/push/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        token: 'hitech_admin_2025',
                        ...notificationData
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Real background push sent:', result);
                    alert(`âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø®Ù„ÙÙŠ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ø¥Ù„Ù‰ ${result.clientsNotified} Ø¬Ù‡Ø§Ø²!\\n\\nğŸš€ Ø¬Ø±Ø¨ Ø¥ØºÙ„Ø§Ù‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØªØµÙØ­Ø§Øª - Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø³ÙŠØµÙ„!`);
                } else {
                    throw new Error('ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø®Ù„ÙÙŠ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ');
                }
                
            } catch (error) {
                console.error('Error sending real notification:', error);
                alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±: ' + error.message);
            }
        }

        // Event listeners
        document.getElementById('enablePush').addEventListener('click', enablePushNotifications);
        document.getElementById('testBackground').addEventListener('click', () => sendTestNotification('background'));
        document.getElementById('testUrgent').addEventListener('click', () => sendTestNotification('urgent'));

        // Initialize
        updateSystemInfo();
        
        // Show initial instructions
        document.getElementById('pushStatus').innerHTML = 
            '<div class="status info">ğŸ“‹ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©" Ù„Ù„Ø¨Ø¯Ø¡</div>';
    </script>
</body>
</html>