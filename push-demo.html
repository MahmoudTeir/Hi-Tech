<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اختبار الإشعارات الخلفية - هاي تك</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1E293B 0%, #0F172A 30%, #22C55E 100%);
            min-height: 100vh;
            padding: 20px;
            color: white;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 32px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #22C55E;
        }

        .demo-section {
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
        }

        .demo-button {
            background: linear-gradient(135deg, #22C55E, #16A34A);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
        }

        .demo-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(34, 197, 94, 0.4);
        }

        .demo-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .status {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            font-weight: 600;
        }

        .status.success {
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid #22C55E;
            color: #22C55E;
        }

        .status.error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid #EF4444;
            color: #EF4444;
        }

        .status.info {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid #3B82F6;
            color: #3B82F6;
        }

        .instruction {
            background: rgba(59, 130, 246, 0.1);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border-right: 4px solid #3B82F6;
        }

        .step {
            margin: 15px 0;
            padding-right: 30px;
            position: relative;
        }

        .step::before {
            content: "✓";
            position: absolute;
            right: 0;
            color: #22C55E;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔔 اختبار الإشعارات الخلفية</h1>
        
        <div class="instruction">
            <h3>📱 كيفية اختبار الإشعارات الخلفية:</h3>
            <div class="step">اضغط على "تفعيل الإشعارات الخلفية"</div>
            <div class="step">اسمح بالإشعارات عند طلب الإذن</div>
            <div class="step">اضغط على "إرسال إشعار تجريبي"</div>
            <div class="step">أغلق هذه الصفحة أو المتصفح</div>
            <div class="step">اضغط مرة أخرى على "إرسال إشعار خلفي" - يجب أن يصل الإشعار حتى لو كانت الصفحة مغلقة!</div>
        </div>
        
        <div class="demo-section">
            <h3>🔧 إعداد الإشعارات الخلفية</h3>
            <button class="demo-button" id="enablePush">
                📱 تفعيل الإشعارات الخلفية
            </button>
            <div id="pushStatus"></div>
        </div>
        
        <div class="demo-section">
            <h3>🧪 اختبار الإشعارات</h3>
            <button class="demo-button" id="testNormal">
                🔔 إرسال إشعار عادي
            </button>
            <button class="demo-button" id="testBackground">
                📤 إرسال إشعار خلفي
            </button>
            <button class="demo-button" id="testUrgent">
                🚨 إرسال إشعار عاجل
            </button>
        </div>
        
        <div class="demo-section">
            <h3>📊 معلومات النظام</h3>
            <div id="systemInfo"></div>
        </div>
    </div>

    <script src="js/enhanced-notifications.js"></script>
    <script>
        let pushSupported = false;
        let pushSubscription = null;

        // Check system capabilities
        function updateSystemInfo() {
            const info = {
                'Service Worker': 'serviceWorker' in navigator ? '✅ مدعوم' : '❌ غير مدعوم',
                'Push API': 'PushManager' in window ? '✅ مدعوم' : '❌ غير مدعوم',  
                'Notifications': 'Notification' in window ? '✅ مدعوم' : '❌ غير مدعوم',
                'Permission': Notification.permission === 'granted' ? '✅ ممنوح' : 
                             Notification.permission === 'denied' ? '❌ مرفوض' : '⏳ لم يُطلب بعد'
            };
            
            document.getElementById('systemInfo').innerHTML = 
                Object.entries(info).map(([key, value]) => `<div><strong>${key}:</strong> ${value}</div>`).join('');
        }

        // Enable push notifications
        async function enablePushNotifications() {
            const enableBtn = document.getElementById('enablePush');
            const statusDiv = document.getElementById('pushStatus');
            
            enableBtn.disabled = true;
            enableBtn.textContent = '⏳ جاري التفعيل...';
            
            try {
                // Request notification permission
                if (Notification.permission === 'default') {
                    const permission = await Notification.requestPermission();
                    if (permission !== 'granted') {
                        throw new Error('تم رفض إذن الإشعارات');
                    }
                }
                
                // Register service worker
                if ('serviceWorker' in navigator) {
                    const registration = await navigator.serviceWorker.register('/sw.js');
                    console.log('Service Worker registered:', registration);
                    
                    // Subscribe to push notifications
                    if ('PushManager' in window) {
                        pushSubscription = await registration.pushManager.subscribe({
                            userVisibleOnly: true,
                            applicationServerKey: null // In production, use VAPID keys
                        });
                        
                        console.log('Push subscription:', pushSubscription);
                        
                        // Send subscription to server
                        const response = await fetch('/api/push/subscribe', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                subscription: pushSubscription.toJSON(),
                                clientId: 'demo_' + Date.now()
                            })
                        });
                        
                        if (!response.ok) {
                            throw new Error('فشل في تسجيل الاشتراك في الخادم');
                        }
                        
                        const result = await response.json();
                        console.log('Subscription registered:', result);
                        
                        pushSupported = true;
                        statusDiv.innerHTML = '<div class="status success">✅ تم تفعيل الإشعارات الخلفية بنجاح!</div>';
                        enableBtn.textContent = '✅ مُفعل';
                        
                    } else {
                        throw new Error('Push Manager غير مدعوم');
                    }
                } else {
                    throw new Error('Service Workers غير مدعوم');
                }
                
            } catch (error) {
                console.error('Error enabling push notifications:', error);
                statusDiv.innerHTML = `<div class="status error">❌ خطأ: ${error.message}</div>`;
                enableBtn.disabled = false;
                enableBtn.textContent = '📱 تفعيل الإشعارات الخلفية';
            }
            
            updateSystemInfo();
        }

        // Send test notifications
        async function sendTestNotification(type) {
            const notifications = {
                normal: {
                    notificationType: 'service_announcement',
                    title: 'إشعار تجريبي',
                    message: 'هذا إشعار تجريبي عادي 📱',
                    priority: 'normal'
                },
                background: {
                    notificationType: 'maintenance_alert',
                    title: 'إشعار خلفي',
                    message: 'يعمل هذا الإشعار حتى لو كانت الصفحة مغلقة! 🚀',
                    priority: 'high'
                },
                urgent: {
                    notificationType: 'connection_lost',
                    title: 'إشعار عاجل',
                    message: 'هذا إشعار عاجل مهم جداً! ⚠️',
                    priority: 'urgent'
                }
            };
            
            const notificationData = notifications[type];
            
            try {
                // For background notifications, use the push API
                if (type === 'background' && pushSupported) {
                    const response = await fetch('/api/push/send', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            token: 'hitech_admin_2025',
                            ...notificationData
                        })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log('Background push sent:', result);
                        alert('✅ تم إرسال الإشعار الخلفي! أغلق الصفحة لاختباره.');
                    } else {
                        throw new Error('فشل في إرسال الإشعار الخلفي');
                    }
                } else {
                    // Use regular notification system
                    if (window.enhancedNotifications) {
                        window.enhancedNotifications.showNotification({
                            ...notificationData,
                            timestamp: Date.now(),
                            duration: 10000
                        });
                    } else {
                        // Fallback to browser notification
                        new Notification(notificationData.title, {
                            body: notificationData.message,
                            icon: '/icons/icon-192x192.png'
                        });
                    }
                }
                
            } catch (error) {
                console.error('Error sending notification:', error);
                alert('❌ خطأ في إرسال الإشعار: ' + error.message);
            }
        }

        // Event listeners
        document.getElementById('enablePush').addEventListener('click', enablePushNotifications);
        document.getElementById('testNormal').addEventListener('click', () => sendTestNotification('normal'));
        document.getElementById('testBackground').addEventListener('click', () => sendTestNotification('background'));
        document.getElementById('testUrgent').addEventListener('click', () => sendTestNotification('urgent'));

        // Initialize
        updateSystemInfo();
    </script>
</body>
</html>