<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اختبار الإشعارات الخلفية الحقيقية - هاي تك</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1E293B 0%, #0F172A 30%, #22C55E 100%);
            min-height: 100vh;
            padding: 20px;
            color: white;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 32px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #22C55E;
        }

        .demo-section {
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
        }

        .demo-button {
            background: linear-gradient(135deg, #22C55E, #16A34A);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
        }

        .demo-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(34, 197, 94, 0.4);
        }

        .demo-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .status {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            font-weight: 600;
        }

        .status.success {
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid #22C55E;
            color: #22C55E;
        }

        .status.error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid #EF4444;
            color: #EF4444;
        }

        .status.info {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid #3B82F6;
            color: #3B82F6;
        }

        .instruction {
            background: rgba(59, 130, 246, 0.1);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border-right: 4px solid #3B82F6;
        }

        .step {
            margin: 15px 0;
            padding-right: 30px;
            position: relative;
        }

        .step::before {
            content: "✓";
            position: absolute;
            right: 0;
            color: #22C55E;
            font-weight: bold;
        }

        .highlight {
            background: rgba(239, 68, 68, 0.2);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border-right: 4px solid #EF4444;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔔 اختبار الإشعارات الخلفية الحقيقية</h1>
        
        <div class="highlight">
            <h3>🚀 تحديث مهم: الآن مع الإشعارات الخلفية الحقيقية!</h3>
            <p>يمكن الآن إرسال إشعارات تعمل حتى عند إغلاق جميع المتصفحات نهائياً!</p>
        </div>
        
        <div class="instruction">
            <h3>📱 كيفية اختبار الإشعارات الخلفية الحقيقية:</h3>
            <div class="step">اضغط على "تفعيل الإشعارات الخلفية الحقيقية"</div>
            <div class="step">اسمح بالإشعارات عند طلب الإذن</div>
            <div class="step">اضغط على "إرسال إشعار خلفي حقيقي"</div>
            <div class="step">أغلق جميع المتصفحات نهائياً</div>
            <div class="step">استخدم الكمبيوتر الآخر أو API لإرسال إشعار - يجب أن يصل حتى مع إغلاق جميع المتصفحات!</div>
        </div>
        
        <div class="demo-section">
            <h3>🔧 إعداد الإشعارات الخلفية الحقيقية</h3>
            <button class="demo-button" id="enablePush">
                📱 تفعيل الإشعارات الخلفية الحقيقية
            </button>
            <div id="pushStatus"></div>
        </div>
        
        <div class="demo-section">
            <h3>🧪 اختبار الإشعارات</h3>
            <button class="demo-button" id="testBackground">
                📤 إرسال إشعار خلفي حقيقي
            </button>
            <button class="demo-button" id="testUrgent">
                🚨 إرسال إشعار عاجل خلفي
            </button>
        </div>
        
        <div class="demo-section">
            <h3>📊 معلومات النظام</h3>
            <div id="systemInfo"></div>
        </div>
        
        <div class="demo-section">
            <h3>🔗 اختبار من خارج الصفحة</h3>
            <p>لاختبار الإشعارات الخلفية الحقيقية، استخدم:</p>
            <pre style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; overflow-x: auto;">
curl -X POST http://10.10.10.196:3000/api/push/send \\
  -H "Content-Type: application/json" \\
  -d '{
    "token": "hitech_admin_2025",
    "notificationType": "maintenance_alert",
    "title": "اختبار الإشعار الخلفي",
    "message": "هذا يعمل حتى مع إغلاق جميع المتصفحات! 🚀",
    "priority": "urgent"
  }'
            </pre>
        </div>
    </div>

    <script>
        let pushSupported = false;
        let pushSubscription = null;

        // Helper function to convert VAPID key
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        // Check system capabilities
        function updateSystemInfo() {
            const info = {
                'Service Worker': 'serviceWorker' in navigator ? '✅ مدعوم' : '❌ غير مدعوم',
                'Push API': 'PushManager' in window ? '✅ مدعوم' : '❌ غير مدعوم',  
                'Notifications': 'Notification' in window ? '✅ مدعوم' : '❌ غير مدعوم',
                'Permission': Notification.permission === 'granted' ? '✅ ممنوح' : 
                             Notification.permission === 'denied' ? '❌ مرفوض' : '⏳ لم يُطلب بعد',
                'VAPID Support': 'PushManager' in window && 'getKey' in PushSubscription.prototype ? '✅ مدعوم' : '❌ غير مدعوم'
            };
            
            document.getElementById('systemInfo').innerHTML = 
                Object.entries(info).map(([key, value]) => `<div><strong>${key}:</strong> ${value}</div>`).join('');
        }

        // Enable real push notifications
        async function enablePushNotifications() {
            const enableBtn = document.getElementById('enablePush');
            const statusDiv = document.getElementById('pushStatus');
            
            enableBtn.disabled = true;
            enableBtn.textContent = '⏳ جاري التفعيل الحقيقي...';
            
            try {
                // Request notification permission
                if (Notification.permission === 'default') {
                    const permission = await Notification.requestPermission();
                    if (permission !== 'granted') {
                        throw new Error('تم رفض إذن الإشعارات');
                    }
                }
                
                // Get VAPID public key from server
                const vapidResponse = await fetch('/api/push/vapid-public-key');
                if (!vapidResponse.ok) {
                    throw new Error('فشل في الحصول على مفتاح VAPID');
                }
                const vapidData = await vapidResponse.json();
                const vapidPublicKey = vapidData.publicKey;
                
                console.log('🔑 VAPID Public Key received:', vapidPublicKey);
                statusDiv.innerHTML = '<div class="status info">🔑 تم الحصول على مفتاح VAPID...</div>';
                
                // Register service worker
                if ('serviceWorker' in navigator) {
                    const registration = await navigator.serviceWorker.register('/sw.js');
                    console.log('Service Worker registered:', registration);
                    statusDiv.innerHTML = '<div class="status info">👷 تم تسجيل Service Worker...</div>';
                    
                    // Subscribe to push notifications with VAPID key
                    if ('PushManager' in window) {
                        pushSubscription = await registration.pushManager.subscribe({
                            userVisibleOnly: true,
                            applicationServerKey: urlBase64ToUint8Array(vapidPublicKey)
                        });
                        
                        console.log('Real Push subscription:', pushSubscription);
                        statusDiv.innerHTML = '<div class="status info">📡 تم إنشاء اشتراك الدفع الحقيقي...</div>';
                        
                        // Send subscription to server
                        const response = await fetch('/api/push/subscribe', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                subscription: pushSubscription.toJSON(),
                                clientId: 'real_demo_' + Date.now()
                            })
                        });
                        
                        if (!response.ok) {
                            throw new Error('فشل في تسجيل الاشتراك في الخادم');
                        }
                        
                        const result = await response.json();
                        console.log('Real subscription registered:', result);
                        
                        pushSupported = true;
                        statusDiv.innerHTML = '<div class="status success">✅ تم تفعيل الإشعارات الخلفية الحقيقية بنجاح!</div>';
                        enableBtn.textContent = '✅ مُفعل (حقيقي)';
                        
                        // Show test notification immediately
                        setTimeout(() => {
                            statusDiv.innerHTML += '<div class="status success">🔔 جرب إغلاق جميع المتصفحات ثم أرسل إشعار!</div>';
                        }, 1000);
                        
                    } else {
                        throw new Error('Push Manager غير مدعوم');
                    }
                } else {
                    throw new Error('Service Workers غير مدعوم');
                }
                
            } catch (error) {
                console.error('Error enabling real push notifications:', error);
                statusDiv.innerHTML = `<div class="status error">❌ خطأ: ${error.message}</div>`;
                enableBtn.disabled = false;
                enableBtn.textContent = '📱 تفعيل الإشعارات الخلفية الحقيقية';
            }
            
            updateSystemInfo();
        }

        // Send test notifications
        async function sendTestNotification(type) {
            const notifications = {
                background: {
                    notificationType: 'maintenance_alert',
                    title: 'إشعار خلفي حقيقي',
                    message: 'هذا إشعار خلفي حقيقي يعمل حتى مع إغلاق جميع المتصفحات! 🚀',
                    priority: 'high'
                },
                urgent: {
                    notificationType: 'connection_lost',
                    title: 'إشعار عاجل خلفي',
                    message: '⚠️ هذا إشعار عاجل حقيقي - أغلق المتصفح واختبره!',
                    priority: 'urgent'
                }
            };
            
            const notificationData = notifications[type];
            
            try {
                // Send real background push notification
                const response = await fetch('/api/push/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        token: 'hitech_admin_2025',
                        ...notificationData
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Real background push sent:', result);
                    alert(`✅ تم إرسال الإشعار الخلفي الحقيقي إلى ${result.clientsNotified} جهاز!\\n\\n🚀 جرب إغلاق جميع المتصفحات - الإشعار سيصل!`);
                } else {
                    throw new Error('فشل في إرسال الإشعار الخلفي الحقيقي');
                }
                
            } catch (error) {
                console.error('Error sending real notification:', error);
                alert('❌ خطأ في إرسال الإشعار: ' + error.message);
            }
        }

        // Event listeners
        document.getElementById('enablePush').addEventListener('click', enablePushNotifications);
        document.getElementById('testBackground').addEventListener('click', () => sendTestNotification('background'));
        document.getElementById('testUrgent').addEventListener('click', () => sendTestNotification('urgent'));

        // Initialize
        updateSystemInfo();
        
        // Show initial instructions
        document.getElementById('pushStatus').innerHTML = 
            '<div class="status info">📋 اضغط على "تفعيل الإشعارات الخلفية الحقيقية" للبدء</div>';
    </script>
</body>
</html>